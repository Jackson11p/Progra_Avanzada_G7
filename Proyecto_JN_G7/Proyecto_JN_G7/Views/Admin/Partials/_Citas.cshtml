@model IEnumerable<Proyecto_JN_G7.Models.CitaUnificada>

<div class="card">
    <div class="card-header d-flex align-items-center justify-content-between">
        <div class="fw-semibold">
            <i class="bi bi-calendar2-check me-1"></i> Citas (todas)
        </div>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-primary" data-action="new-cita">
                <i class="bi bi-plus-circle"></i> Nueva Cita
            </button>
            <button type="button" class="btn btn-sm btn-outline-primary"
                    onclick="const a=document.querySelector('#adminSidebar [data-partial=&quot;Citas&quot;]'); if(a) a.click();">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th>Tipo</th>
                    <th>Fecha/Hora</th>
                    <th>Paciente</th>
                    <th>Doctor</th>
                    <th>Estado</th>
                    <th>Motivo</th>
                    <th>Contacto</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (!Model.Any())
                {
                    <tr><td colspan="8" class="text-center text-muted py-4">No hay registros.</td></tr>
                }
                else
                {
                    foreach (var x in Model)
                    {
                        var isCita = string.Equals(x.Tipo, "Cita", StringComparison.OrdinalIgnoreCase);
                        var isoFecha = x.FechaHora.ToString("yyyy-MM-ddTHH:mm");
                        <tr>
                            <td>
                                @if (isCita)
                                {
                                    <span class="badge text-bg-primary">Cita</span>
                                }
                                else
                                {

                                    <span class="badge text-bg-warning text-dark">Solicitud</span>
                                }
                            </td>
                            <td>
                                @x.FechaHora.ToString("dd/MM/yyyy HH:mm")
                                <div class="text-muted small">Reg.: @x.FechaRegistro.ToString("dd/MM/yyyy HH:mm")</div>
                            </td>
                            <td>@(x.PacienteNombre ?? $"PacienteID: {x.PacienteID}")</td>
                            <td>@(x.DoctorNombre ?? $"DoctorID: {x.DoctorID}")</td>

                            <td>@x.Estado</td>
                            <td class="text-truncate" style="max-width:260px;">@x.Motivo</td>
                            <td class="small">
                                @if (!string.IsNullOrWhiteSpace(x.Email))
                                {
                                    <div><i class="bi bi-envelope me-1"></i>@x.Email</div>
                                }
                                @if (!string.IsNullOrWhiteSpace(x.Telefono))
                                {
                                    <div><i class="bi bi-telephone me-1"></i>@x.Telefono</div>
                                }
                            </td>
                            <td>
                                @if (isCita)
                                {
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary"
                                                data-action="edit-cita"
                                                data-cita-id="@x.CitaID"
                                                data-paciente-id="@x.PacienteID"
                                                data-doctor-id="@x.DoctorID"
                                                data-fecha="@isoFecha"
                                                data-estado="@x.Estado"
                                                data-motivo="@x.Motivo">
                                            <i class="bi bi-pencil-square"></i> Editar
                                        </button>
                                        <button class="btn btn-outline-danger"
                                                data-action="delete-cita"
                                                data-cita-id="@x.CitaID">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-success"
                                                data-action="attend-solicitud"
                                                data-solicitud-id="@x.SolicitudID"
                                                data-motivo="@x.Motivo"
                                                data-email="@x.Email"
                                                data-nombre="@x.PacienteNombre">
                                            <i class="bi bi-check2-circle"></i> Atender
                                        </button>
                                        <button class="btn btn-outline-secondary"
                                                data-action="delete-solicitud"
                                                data-solicitud-id="@x.SolicitudID">
                                            <i class="bi bi-x-circle"></i> Descartar
                                        </button>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal: crear/editar cita -->
<div class="modal fade" id="modalCita" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="formCita">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCitaTitle">Cita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="citaId">

                <div class="mb-2">
                    <label class="form-label">Paciente</label>
                    @await Html.PartialAsync(
                    "Partials/_SelectorPaciente",
                                        (IEnumerable<Proyecto_JN_G7.Models.PacienteListItem>)(ViewBag.Pacientes ?? new List<Proyecto_JN_G7.Models.PacienteListItem>()),
                                        new ViewDataDictionary(ViewData) {
                                        { "SelectId", "pacienteEdit" },
                                        { "SelectName", "pacienteEdit" }
                                        }
                                        )
                </div>
                <div class="d-flex justify-content-end mb-2">
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            data-action="open-new-paciente"
                            data-target-select="#pacienteEdit">
                        <i class="bi bi-person-plus"></i> Crear paciente
                    </button>
                </div>
                <div class="mb-2">
                    <label class="form-label">Doctor</label>
                    @await Html.PartialAsync(
                    "Partials/_SelectDoctor",
                                        (IEnumerable<Proyecto_JN_G7.Models.DoctorListItem>)(ViewBag.Doctores ?? new List<Proyecto_JN_G7.Models.DoctorListItem>()),
                                        new ViewDataDictionary(ViewData) {
                                        { "SelectId", "doctorEdit" },           
                                        { "SelectName", "doctorEdit" },
                                        { "ValueField", "Id" }                  
                                        }
                                        )
                </div>
                <div class="mb-2">
                    <label class="form-label">Fecha y hora</label>
                    <input type="datetime-local" class="form-control" id="fechaHora" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="estado">
                        <option value="Pendiente">Pendiente</option>
                        <option value="Confirmada">Confirmada</option>
                        <option value="Completada">Completada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="mb-0">
                    <label class="form-label">Motivo</label>
                    <textarea class="form-control" id="motivo" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-primary" type="submit">Guardar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: atender solicitud -->
<div class="modal fade" id="modalAtender" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="formAtender">
            <div class="modal-header">
                <h5 class="modal-title">Atender solicitud</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="solicitudId">

                <div class="mb-2">
                    <label class="form-label">Paciente</label>
                    @await Html.PartialAsync(
                                        "Partials/_SelectorPaciente",
                                        (IEnumerable<Proyecto_JN_G7.Models.PacienteListItem>)(ViewBag.Pacientes ?? new List<Proyecto_JN_G7.Models.PacienteListItem>()),
                                        new ViewDataDictionary(ViewData) {
                                        { "SelectId", "a_pacienteSelect" },
                                        { "SelectName", "a_pacienteSelect" }
                                        }
                                        )
                </div>
                <div class="d-flex justify-content-end mb-2">
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            data-action="open-new-paciente"
                            data-target-select="#a_pacienteSelect">
                        <i class="bi bi-person-plus"></i> Crear paciente
                    </button>
                </div>

                <!-- si no existe el paciente -->
                <div id="a_pacienteHint" class="text-muted small d-none">
                    No encontramos al paciente por email. Puedes crearlo con el botón “Crear paciente”.
                </div>
                <div class="mb-2">
                    <label class="form-label">Doctor</label>
                    @await Html.PartialAsync(
                                        "Partials/_SelectDoctor",
                                        (IEnumerable<Proyecto_JN_G7.Models.DoctorListItem>)(ViewBag.Doctores ?? new List<Proyecto_JN_G7.Models.DoctorListItem>()),
                                        new ViewDataDictionary(ViewData) {
                                        { "SelectId", "a_doctorSelect" },       
                                        { "SelectName", "a_doctorSelect" },
                                        { "ValueField", "Id" }                  
                                        }
                                        )
                </div>
                <div class="mb-2">
                    <label class="form-label">Fecha y hora</label>
                    <input type="datetime-local" class="form-control" id="a_fechaHora" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Estado</label>
                    <select class="form-select" id="a_estado">
                        <option value="Pendiente">Pendiente</option>
                        <option value="Confirmada">Confirmada</option>
                        <option value="Completada">Completada</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="mb-0">
                    <label class="form-label">Motivo</label>
                    <textarea class="form-control" id="a_motivo" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-success" type="submit">Crear cita</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Crear Paciente -->
<div class="modal fade" id="modalPaciente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="formPaciente">
            <div class="modal-header">
                <h5 class="modal-title">Crear paciente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Cédula</label>
                    <input type="text" class="form-control" id="p_cedula" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Nombre completo</label>
                    <input type="text" class="form-control" id="p_nombre" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Correo electrónico</label>
                    <input type="email" class="form-control" id="p_email" required>
                </div>
                <div class="mb-0">
                    <label class="form-label">Contraseña (opcional)</label>
                    <input type="password" class="form-control" id="p_pass" placeholder="Si se omite, se asigna una temporal">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
                <button class="btn btn-success" type="submit">Crear paciente</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de confirmación (genérico y reutilizable) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-question-circle-fill me-2"></i>
                    <span id="cfTitle">Confirmar</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="cfMessage">¿Seguro?</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="cfCancel">Cancelar</button>
                <button type="button" class="btn btn-danger" id="cfOk">
                    <i class="bi bi-check2-circle me-1"></i>
                    <span id="cfOkText">Sí</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast (notificación) -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:1080">
    <div id="liveToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastBody">Listo</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

